// Importa las funciones necesarias del SDK de Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

// Tu configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAqsD-wMWesTqfvh0TK_5a5IZw0JJldS34",
    authDomain: "mensajes-297b5.firebaseapp.com",
    projectId: "mensajes-297b5",
    storageBucket: "mensajes-297b5.firebasestorage.app",
    messagingSenderId: "557469481203",
    appId: "1:557469481203:web:c6eeb657bd5e3aaf6adf86",
    measurementId: "G-J8Z4SX2KHB"
};

// Inicializa Firebase y obtén una referencia a Firestore
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let userId = "";
let isStealthMode = false;

// --------------------------------------------------
// Funciones principales
// --------------------------------------------------

async function initialize() {
    try {
        const statusBanner = document.getElementById('status-message');
        statusBanner.classList.remove('hidden');
        statusBanner.textContent = '⏳ Generando identificador seguro...';
        
        userId = generateRandomId();
        document.getElementById('userId').textContent = userId;

        statusBanner.textContent = '✅ Conectado a la base de datos.';
        setTimeout(() => statusBanner.classList.add('hidden'), 3000);

        document.getElementById('loading-spinner').classList.add('hidden');
        document.getElementById('userId').classList.remove('hidden');
        setupEventListeners();

        // Escuchar mensajes entrantes
        listenForMessages();

    } catch (e) {
        showToast("Error de conexión. Revisa tu consola.", "error");
        console.error("Error al inicializar:", e);
    }
}

async function sendMessage() {
    const recipientId = document.getElementById('recipientId').value.trim();
    const messageText = document.getElementById('messageText').value.trim();
    
    if (!recipientId || !messageText) {
        showToast("Completa todos los campos", "error");
        return;
    }

    if (recipientId === userId) {
        showToast("No puedes enviarte mensajes a ti mismo", "error");
        return;
    }

    try {
        await addDoc(collection(db, "messages"), {
            senderId: userId,
            recipientId: recipientId,
            message: messageText,
            timestamp: serverTimestamp()
        });
        showToast("Mensaje transmitido con éxito", "success");
        document.getElementById('messageText').value = '';
    } catch (e) {
        showToast("Error al transmitir el mensaje", "error");
        console.error("Error al añadir documento: ", e);
    }
}

function listenForMessages() {
    const q = query(collection(db, "messages"), where("recipientId", "==", userId), orderBy("timestamp", "desc"));
    
    onSnapshot(q, (querySnapshot) => {
        querySnapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const messageData = change.doc.data();
                displayMessage(messageData.message, messageData.senderId, change.doc.id);
            }
        });
    }, (error) => {
        console.error("Error al escuchar mensajes:", error);
        showToast("Error en la conexión en tiempo real", "error");
    });
}

async function deleteMessage(messageId) {
    try {
        await deleteDoc(doc(db, "messages", messageId));
        console.log("Mensaje borrado:", messageId);
    } catch (e) {
        console.error("Error al borrar mensaje:", e);
    }
}

// --------------------------------------------------
// Funciones de utilidad
// --------------------------------------------------

function setupEventListeners() {
    const userIdEl = document.getElementById('userId');
    const clearBtn = document.getElementById('clearRecipientBtn');
    const sendBtn = document.getElementById('sendMessageBtn');
    const recipientInput = document.getElementById('recipientId');

    userIdEl.onclick = () => {
        // Usa una API de navegador más segura para copiar al portapapeles
        navigator.clipboard.writeText(userIdEl.textContent).then(() => {
            showToast("ID copiado discretamente", "success");
        }).catch(() => {
            showToast("Error al copiar", "error");
        });
    };

    clearBtn.addEventListener('click', () => {
        recipientInput.value = '';
        clearChatHistory();
        showToast("Campo limpiado", "success");
    });
    
    sendBtn.addEventListener('click', sendMessage);

    setupScreenshotProtection();
}

function displayMessage(text, senderId, messageId) {
    const noMessages = document.getElementById('no-messages');
    const messagesContainer = document.getElementById('messagesContainer');
    
    if (noMessages) noMessages.style.display = 'none';

    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-bubble stealth-mode';
    messageWrapper.dataset.messageId = messageId;
    
    const senderP = document.createElement('p');
    senderP.className = 'message-sender';
    senderP.textContent = `De: ${senderId}`;
    
    const textP = document.createElement('p');
    textP.className = 'message-text';
    textP.textContent = text;

    messageWrapper.appendChild(senderP);
    messageWrapper.appendChild(textP);
    messagesContainer.appendChild(messageWrapper);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    messagesContainer.classList.add('pulse-glow');
    setTimeout(() => messagesContainer.classList.remove('pulse-glow'), 2000);

    // Auto-destrucción y borrado de la base de datos después de 20 segundos
    setTimeout(() => {
        messageWrapper.classList.add('fading');
        setTimeout(() => {
            messageWrapper.remove();
            checkIfEmpty();
            deleteMessage(messageId);
        }, 500);
    }, 20000);
}

function generateRandomId() {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 10; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return `ghost-${result}`;
}

function showToast(message, type = "success") {
    const toast = document.getElementById('toast-notification');
    const toastText = toast.querySelector('p');
    
    toastText.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.remove('hidden');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

function clearChatHistory() {
    const messagesContainer = document.getElementById('messagesContainer');
    const messages = messagesContainer.querySelectorAll('.message-bubble');
    
    messages.forEach(message => {
        message.classList.add('fading');
        setTimeout(() => message.remove(), 200);
    });
    
    setTimeout(showNoMessages, 300);
}

function showNoMessages() {
    const noMessages = document.getElementById('no-messages');
    const messagesContainer = document.getElementById('messagesContainer');
    
    if (messagesContainer.querySelectorAll('.message-bubble').length === 0) {
        noMessages.style.display = 'block';
    }
}

function checkIfEmpty() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer.querySelectorAll('.message-bubble').length === 0) {
        showNoMessages();
    }
}

function activateStealthMode() {
    if (isStealthMode) return;
    
    isStealthMode = true;
    const messages = document.querySelectorAll('.message-bubble');
    
    messages.forEach(message => {
        message.classList.add('fading');
        setTimeout(() => message.remove(), 500);
    });

    showNoMessages();
    showToast("Modo sigiloso activado", "error");
    
    setTimeout(() => {
        isStealthMode = false;
    }, 3000);
}

function setupScreenshotProtection() {
    document.addEventListener('keydown', (e) => {
        const isScreenshot = 
            e.key === 'PrintScreen' ||
            (e.metaKey && e.shiftKey && ['3', '4', '5'].includes(e.key)) ||
            (e.ctrlKey && e.shiftKey && e.key === 'S') ||
            (e.altKey && e.key === 'PrintScreen');

        if (isScreenshot) {
            activateStealthMode();
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            activateStealthMode();
        }
    });
}

// Deshabilitar algunas teclas de desarrollo
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', (e) => {
    if (e.key === 'F12' || 
        (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
        (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        activateStealthMode();
    }
});

// Inicializar cuando se carga la página
window.onload = initialize;
