<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shhhhh Es Un Secreto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            /* Fondo con patrón de cuadrícula para un look de ciencia ficción más misterioso */
            background-color: #040710; /* Azul muy oscuro */
            background-image: radial-gradient(#101625 1px, transparent 1px); /* Cuadrícula azul oscuro */
            background-size: 20px 20px;
            font-family: 'Roboto Mono', monospace;
            color: #A1B2C8; /* Tono de gris azulado para texto general, más sutil */
        }
        .container-panel {
            background-color: rgba(10, 15, 25, 0.95); /* Azul oscuro casi negro con ligera transparencia */
            border: 2px solid #2B3A4F; /* Borde mate en lugar de neón */
            box-shadow: 0 0 10px rgba(0,0,0,0.3), inset 0 0 5px rgba(0,0,0,0.1); /* Sombra suave y sutil */
            backdrop-filter: blur(7px);
            border-radius: 15px;
        }
        .text-subtle {
            color: #A1B2C8; /* Gris azulado para un look más mate */
            text-shadow: none; /* Elimina el brillo neón */
            font-family: 'Orbitron', sans-serif;
        }
        .input-glow:focus {
            box-shadow: 0 0 5px rgba(43, 58, 79, 0.5), inset 0 0 3px rgba(43, 58, 79, 0.3); /* Sombra de enfoque sutil */
            border-color: #2B3A4F;
        }
        .btn-send {
            background-color: #2C3A4F; /* Azul oscuro mate para el botón */
            transition: all 0.3s ease;
            box-shadow: none; /* Elimina la sombra neón */
            border: 1px solid #5E6A7A; /* Borde sutil */
        }
        .btn-send:hover {
            background-color: #3A4E67; /* Tono ligeramente más claro al pasar el ratón */
            transform: translateY(-2px) scale(1.01); /* Efecto de "levantamiento" sutil */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Sombra al pasar el ratón para dar profundidad */
        }
        .btn-send:active {
            transform: translateY(1px) scale(1); /* Efecto de "presión" al hacer clic */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .message-bubble {
            background-color: rgba(18, 28, 45, 0.9); /* Azul oscuro para burbujas de mensaje */
            border-left: 3px solid #5E6A7A; /* Borde sutil en lugar de neón */
            animation: slideInLeft 0.5s ease-out;
            border-radius: 8px;
        }
        .toast {
            animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
            background-color: #2C3A4F; /* Color de fondo del toast mate */
            color: #A1B2C8; /* Texto claro en el toast */
            box-shadow: 0 0 10px rgba(0,0,0,0.4);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInLeft {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .relative-input-container {
            position: relative;
        }
        .clear-recipient-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #A1B2C8; /* Color de texto general */
            font-size: 1.3rem;
            line-height: 1;
            transition: color 0.3s ease;
        }
        .clear-recipient-btn:hover {
            color: #5E6A7A; /* Color mate al pasar el ratón */
        }
        .fading-out {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 0;
            transform: scale(0.95); /* Se encoge un poco al desaparecer */
        }
        #status-message {
            background-color: #5E6A7A; /* Gris oscuro para el estado de conexión */
            color: #1A222E; /* Texto oscuro */
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        #status-message.hidden {
            display: none;
        }
        .bg-gray-900\/50 {
            background-color: rgba(18, 28, 45, 0.7);
            border: 1px solid #2B3A4F; /* Borde sutil */
        }
        .placeholder-gray-500::placeholder {
            color: #5E6A7A; /* Color de placeholder mate */
        }
        .internal-panel {
            background-color: #1A222E; /* Gris oscuro mate para los paneles internos */
            border: 1px solid #2C3A4F; /* Borde más sutil */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        #userId:hover {
            color: #5E6A7A; /* Sutil cambio de color en lugar de neón */
            background-color: rgba(44, 58, 79, 0.2);
        }
        /* Estilos para el indicador de presencia */
        .presence-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .online-dot { background-color: #34D399; /* verde */ }
        .offline-dot { background-color: #EF4444; /* rojo */ }
        .checking-dot { background-color: #FBBF24; /* amarillo */ animation: pulse 1.5s infinite; }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(10, 15, 25, 0.95);
            color: #A1B2C8;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 20;
            margin-bottom: 5px;
        }
        .relative-input-container:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto rounded-xl p-6 md:p-8 space-y-6 container-panel">
        <div id="status-message" class="text-black p-3 rounded-lg text-center text-sm font-bold">
            ⏳ Conectando con el Servidor...
        </div>
        
        <div class="text-center">
            <h1 class="text-4xl font-bold text-subtle">GHOST PROJECT</h1>
            <p class="text-gray-400 mt-2 text-sm">Mensajes diseñados para desvanecerse.</p>
        </div>

        <div class="p-4 rounded-lg text-center internal-panel">
            <p class="text-xs text-gray-500 mb-2">Tu Identificador de Enlace:</p>
            <div id="loading-spinner" class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-subtle"></div>
            </div>
            <p id="userId" class="font-mono text-xl text-subtle break-all select-all cursor-pointer hidden"></p>
        </div>

        <form id="sendMessageForm" class="space-y-4">
            <div class="relative-input-container">
                <label for="recipientId" class="block text-sm font-medium text-gray-400 mb-2">
                    Código del Receptor
                </label>
                <div class="relative">
                    <span id="presence-indicator-container" class="absolute top-1/2 left-3 transform -translate-y-1/2 hidden">
                        <span id="presence-indicator" class="presence-indicator checking-dot" data-tooltip="Verificando..."></span>
                        <span id="presence-tooltip" class="tooltip">Verificando...</span>
                    </span>
                    <input type="text" id="recipientId" required placeholder="Ingresa el código del receptor..."
                        class="w-full bg-gray-800 rounded-md px-3 pr-8 py-2 text-white placeholder-gray-500 border border-gray-700 input-glow">
                </div>
                <button type="button" id="clearRecipientBtn" class="clear-recipient-btn" aria-label="Limpiar código del receptor">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                </button>
            </div>
            <div>
                <label for="messageText" class="block text-sm font-medium text-gray-400 mb-2">Mensaje encriptado</label>
                <textarea id="messageText" required rows="4" placeholder="Escribe tu mensaje... no dejes rastro."
                            class="w-full bg-gray-800 rounded-md px-3 py-2 text-white placeholder-gray-500 border border-gray-700 input-glow"></textarea>
            </div>
            <button type="submit"
                    class="w-full btn-send text-white font-bold py-3 px-4 rounded-lg shadow-xl hover:scale-105">
                Transmitir Mensaje
            </button>
        </form>

        <div>
            <h2 class="text-xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-subtle">Buzón Fantasma</h2>
            <div id="messagesContainer" class="space-y-4 h-48 overflow-y-auto p-2 rounded-lg internal-panel">
                <p id="no-messages" class="text-gray-600 text-center py-4">Esperando transmisiones...</p>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg hidden">
        <p>¡Mensaje transmitido!</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Nuevo: Importa Realtime Database
        import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // ✅ Tu configuración real
        const firebaseConfig = {
            apiKey: "AIzaSyAqsD-wMWesTqfvh0TK_5a5IZw0JJldS34",
            authDomain: "mensajes-297b5.firebaseapp.com",
            projectId: "mensajes-297b5",
            storageBucket: "mensajes-297b5.firebasestorage.app",
            messagingSenderId: "557469481203",
            appId: "1:557469481203:web:c6eeb657bd5e3aaf6adf86",
            measurementId: "G-J8Z4SX2KHB"
        };

        // Variables globales
        const appId = "mensajes-297b5";
        let app, auth, db, rtdb, currentUserId; // Nuevo: rtdb
        const userIdElement = document.getElementById('userId');
        const loadingSpinner = document.getElementById('loading-spinner');
        const sendMessageForm = document.getElementById('sendMessageForm');
        const recipientIdInput = document.getElementById('recipientId');
        const messageTextInput = document.getElementById('messageText');
        const messagesContainer = document.getElementById('messagesContainer');
        const noMessagesElement = document.getElementById('no-messages');
        const toastNotification = document.getElementById('toast-notification');
        const statusMessage = document.getElementById('status-message');
        const clearRecipientBtn = document.getElementById('clearRecipientBtn');

        // Nuevas variables para el indicador de presencia
        const presenceIndicator = document.getElementById('presence-indicator');
        const presenceIndicatorContainer = document.getElementById('presence-indicator-container');
        const presenceTooltip = document.getElementById('presence-tooltip');
        let presenceListener = null;
        let debounceTimer = null;
        const onlineThreshold = 120000; // 2 minutos en milisegundos

        async function initialize() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                rtdb = getDatabase(app); // Nuevo: Inicializa Realtime Database

                statusMessage.textContent = 'Conectando con el Servidor...';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        displayUserId();
                        listenForMessages();
                        setupUserPresence(); // Nuevo: Configura el sistema de presencia
                        statusMessage.classList.add('hidden');
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Error al inicializar:", error);
                userIdElement.textContent = "Error de enlace.";
                userIdElement.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                statusMessage.textContent = '❌ Fallo en la conexión. Revisa las reglas de seguridad.';
                statusMessage.style.backgroundColor = 'rgba(220, 38, 38, 0.8)';
            }
        }

        // Nuevo: Funciones para el sistema de presencia
        function setupUserPresence() {
            const userStatusDatabaseRef = ref(rtdb, 'presence/' + currentUserId);

            // Se desconecta cuando el usuario cierra la página
            onDisconnect(userStatusDatabaseRef).set(null);

            // Actualiza la última vez que el usuario estuvo activo cada 30 segundos
            setInterval(() => {
                set(userStatusDatabaseRef, {
                    last_online: Date.now()
                });
            }, 30000);
        }

        function checkRecipientStatus(recipientId) {
            // Limpia el listener anterior si existe
            if (presenceListener) {
                presenceListener();
            }

            // Muestra el indicador y el estado de "Verificando"
            presenceIndicatorContainer.classList.remove('hidden');
            presenceIndicator.className = 'presence-indicator checking-dot';
            presenceTooltip.textContent = 'Verificando...';
            
            // Obtiene la referencia al estado del receptor
            const recipientStatusRef = ref(rtdb, 'presence/' + recipientId);

            // Agrega un listener de tiempo real
            presenceListener = onValue(recipientStatusRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.last_online) {
                    const lastOnlineTime = data.last_online;
                    const isOnline = (Date.now() - lastOnlineTime) < onlineThreshold;
                    if (isOnline) {
                        presenceIndicator.className = 'presence-indicator online-dot';
                        presenceTooltip.textContent = 'En línea';
                    } else {
                        presenceIndicator.className = 'presence-indicator offline-dot';
                        presenceTooltip.textContent = 'Desconectado';
                    }
                } else {
                    presenceIndicator.className = 'presence-indicator offline-dot';
                    presenceTooltip.textContent = 'Usuario no encontrado o desconectado';
                }
            });
        }
        
        // Nuevo: Función para limpiar el indicador de presencia
        function clearPresenceIndicator() {
            if (presenceListener) {
                presenceListener();
                presenceListener = null;
            }
            presenceIndicatorContainer.classList.add('hidden');
        }

        function debounce(func, timeout = 500){
            return (...args) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        const debouncedCheckRecipientStatus = debounce(checkRecipientStatus, 1000);

        function displayUserId() {
            userIdElement.textContent = currentUserId;
            loadingSpinner.classList.add('hidden');
            userIdElement.classList.remove('hidden');
            userIdElement.onclick = () => {
                navigator.clipboard.writeText(currentUserId).then(() => {
                    showToast('ID copiado al portapapeles.');
                }).catch(err => {
                    showToast('Error al copiar el ID.', true);
                });
            };
        }
        
        function showToast(message, isError = false) {
            const toastP = toastNotification.querySelector('p');
            toastP.textContent = message;
            if (isError) {
                toastNotification.style.backgroundColor = '#B34F5C'; /* Color de error mate */
                toastNotification.style.boxShadow = '0 0 10px rgba(179, 79, 92, 0.5)';
                toastNotification.style.color = '#1A222E';
            } else {
                toastNotification.style.backgroundColor = '#5E6A7A'; /* Color de éxito mate */
                toastNotification.style.boxShadow = '0 0 10px rgba(94, 106, 122, 0.5)';
                toastNotification.style.color = '#1A222E';
            }
            toastNotification.classList.remove('hidden');
            setTimeout(() => { toastNotification.classList.add('hidden'); }, 3000);
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const recipientId = recipientIdInput.value.trim();
            const text = messageTextInput.value.trim();
            if (!recipientId || !text || !currentUserId) { showToast("Completa los campos.", true); return; }
            if (recipientId === currentUserId) { showToast("No puedes comunicarte contigo mismo.", true); return; }
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                    senderId: currentUserId,
                    recipientId: recipientId,
                    text: text,
                    timestamp: new Date(),
                });
                showToast("¡Mensaje transmitido con éxito!");
                messageTextInput.value = '';
            } catch (error) {
                console.error("Error en la transmisión:", error);
                showToast("Fallo en la transmisión.", true);
            }
        }
        
        function clearChatHistory() {
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(noMessagesElement);
            noMessagesElement.style.display = 'block';
        }

        function listenForMessages() {
            if (!currentUserId) return;
            const q = query(
                collection(db, `artifacts/${appId}/public/data/messages`),
                where("recipientId", "==", currentUserId)
            );
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageData = change.doc.data();
                        displayMessage(messageData, change.doc.id);
                    }
                });
            });
        }
        
        async function deleteMessage(docId) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/messages`, docId));
                console.log("Mensaje borrado de Firestore:", docId);
            } catch (error) {
                console.error("Error al borrar el mensaje:", error);
            }
        }

        function displayMessage(data, docId) {
            if (noMessagesElement) noMessagesElement.style.display = 'none';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-bubble p-4 rounded-lg shadow-md';
            const senderP = document.createElement('p');
            senderP.className = 'text-xs text-subtle font-bold mb-2 truncate';
            senderP.textContent = `De: ${data.senderId}`;
            const textP = document.createElement('p');
            textP.className = 'text-gray-300 text-sm';
            textP.textContent = data.text;
            messageWrapper.appendChild(senderP);
            messageWrapper.appendChild(textP);
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const disappearTime = 180000;
            setTimeout(() => {
                messageWrapper.classList.add('fading-out');
                setTimeout(() => {
                    messageWrapper.remove();
                }, 500);
            }, disappearTime - 500);

            setTimeout(() => {
                deleteMessage(docId);
            }, disappearTime + 1000);
        }

        window.addEventListener('keyup', (e) => {
            const isPrintScreen = e.key === 'PrintScreen' || (e.key === 'p' && e.ctrlKey);
            const isCmdShift3 = e.metaKey && e.shiftKey && e.key === '3';
            const isCmdShift4 = e.metaKey && e.shiftKey && e.key === '4';
            const isWindowsSnippingTool = e.metaKey && e.shiftKey && e.key === 's';

            if (isPrintScreen || isCmdShift3 || isCmdShift4 || isWindowsSnippingTool) {
                const messages = messagesContainer.querySelectorAll('.message-bubble');
                messages.forEach(message => {
                    message.classList.add('fading-out');
                    setTimeout(() => { message.remove(); }, 500);
                });
                showToast("¡Alerta! Mensajes borrados por intento de captura.", true);
            }
        });
        
        // Nuevo: Evento para verificar el estado del receptor
        recipientIdInput.addEventListener('keyup', (e) => {
            if (e.target.value.trim() === '') {
                clearChatHistory();
                clearPresenceIndicator();
            } else {
                debouncedCheckRecipientStatus(e.target.value.trim());
            }
        });

        clearRecipientBtn.addEventListener('click', () => {
            recipientIdInput.value = '';
            clearChatHistory();
            clearPresenceIndicator();
        });

        sendMessageForm.addEventListener('submit', handleSendMessage);
        window.onload = initialize;
    </script>
</body>
</html>
